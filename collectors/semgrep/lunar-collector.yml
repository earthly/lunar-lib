version: 0

name: semgrep
description: Detects Semgrep security scans via GitHub App or CLI integration
author: support@earthly.dev

default_image: earthly/lunar-scripts:1.0.0
default_image_ci_collectors: native

landing_page:
  display_name: "Semgrep Collector"
  long_description: |
    Detects Semgrep security scanning via GitHub App or CLI integration.
    Automatically categorizes results (SAST for code analysis, SCA for
    Supply Chain) and writes to normalized Component JSON paths.
  category: "security"
  icon: "assets/semgrep.svg"
  status: "stable"

collectors:
  - name: github-app
    description: |
      Detects Semgrep GitHub App scans on pull requests by querying GitHub
      check-runs API. Waits for scan completion and captures results.
      Categorizes as SAST (Code) or SCA (Supply Chain) based on check name.
    mainBash: github-app.sh
    hook:
      type: code
      runs_on: [prs]
    keywords: ["semgrep", "github app", "sast", "code analysis"]

  - name: github-app-default-branch
    description: |
      Provides compliance proof on the default branch by querying Lunar Hub
      for Semgrep data from recent PRs. Since Semgrep GitHub App only posts
      checks on PRs (not the default branch), this collector verifies that
      PRs to this component are being scanned, which implies the merged code
      on the default branch was also scanned.
    mainBash: github-app-default-branch.sh
    image: native
    hook:
      type: code
      runs_on: [default-branch]
    keywords: ["semgrep", "default branch", "compliance proof"]

  - name: cli
    description: |
      Detects Semgrep CLI executions in CI pipelines. Captures command, exit code,
      and version. Categorizes based on flags (--supply-chain for SCA, default SAST).
    mainBash: cli.sh
    hook:
      type: ci-after-command
      pattern: .*\bsemgrep\b.*
    keywords: ["semgrep cli", "ci integration", "sast", "code scanning"]

secrets:
  - name: GH_TOKEN
    description: GitHub token for API access (required for github-app collector)
    required: false
  - name: PG_PASSWORD
    description: Database password for default-branch collector (optional, uses lunar sql connection-string if not set)
    required: false
  - name: PG_USER
    description: Database user for default-branch collector (optional, defaults to api3)
    required: false

example_component_json: |
  {
    "sast": {
      "source": {
        "tool": "semgrep",
        "integration": "github_app"
      },
      "native": {
        "semgrep": {
          "github_app_results": {
            "id": 12345,
            "name": "Semgrep",
            "status": "completed",
            "conclusion": "success"
          }
        }
      }
    }
  }
