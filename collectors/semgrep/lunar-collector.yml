version: 0

name: semgrep
description: Detects Semgrep security scans and collects findings data
author: support@earthly.dev

default_image: earthly/lunar-scripts:1.0.0

landing_page:
  display_name: "Semgrep Collector"
  long_description: |
    Detects Semgrep security scanning via GitHub App or CLI integration.
    Automatically categorizes results (SAST for code analysis, SCA for
    Supply Chain) and writes to normalized Component JSON paths.
  category: "security"
  icon: "assets/semgrep.svg"
  status: "stable"

collectors:
  - name: github-app
    description: |
      Detects Semgrep GitHub App scans on pull requests by querying GitHub
      check-runs API. Waits for scan completion and captures results.
      Categorizes as SAST (Code) or SCA (Supply Chain) based on check name.
    mainBash: github-app.sh
    hook:
      type: code
      runs_on: [prs]
    keywords: ["semgrep", "github app", "sast", "code analysis"]

  - name: github-app-default-branch
    description: |
      Checks if Semgrep GitHub App has run on recent PRs by querying the
      Lunar Hub database. Provides proof of scanning on the default branch
      even though Semgrep doesn't post checks there directly.
    mainBash: github-app-default-branch.sh
    hook:
      type: code
      runs_on: [default-branch]
    keywords: ["semgrep", "default branch", "compliance proof"]

  - name: cli
    description: |
      Detects Semgrep CLI executions in CI pipelines. Captures command, exit code,
      and version. Categorizes based on flags (--supply-chain for SCA, default SAST).
    mainBash: cli.sh
    hook:
      type: ci-after-command
      pattern: .*\bsemgrep\b.*
    keywords: ["semgrep cli", "ci integration", "sast", "code scanning"]

secrets:
  - name: GH_TOKEN
    description: GitHub token for API access (checking check-runs)
    required: true
  - name: PG_PASSWORD
    description: Database password for main branch queries
    required: false

example_component_json: |
  {
    "sast": {
      "source": {
        "tool": "semgrep",
        "version": "1.50.0",
        "integration": "github_app"
      },
      "findings": {
        "critical": 0,
        "high": 2,
        "medium": 5,
        "low": 12,
        "total": 19
      },
      "native": {
        "semgrep": {
          "github_app_results": {
            "id": 12345,
            "name": "Semgrep",
            "status": "completed",
            "conclusion": "success"
          }
        }
      }
    }
  }
