version: 0

name: semgrep
description: Detects Semgrep security scans via GitHub App or CLI integration
author: support@earthly.dev

default_image: earthly/lunar-lib:base-main
default_image_ci_collectors: native

landing_page:
  display_name: "Semgrep Collector"
  long_description: |
    Detects Semgrep security scanning via GitHub App or CLI integration.
    Automatically categorizes results (SAST for code analysis, SCA for
    Supply Chain) and writes to normalized Component JSON paths.
  category: "security"
  icon: "assets/semgrep.svg"
  status: "stable"

collectors:
  - name: github-app
    description: |
      Detects Semgrep GitHub App scans on pull requests by querying GitHub
      check-runs API. Waits for scan completion and captures results.
      Categorizes as SAST (Code) or SCA (Supply Chain) based on check name.
    mainBash: github-app.sh
    hook:
      type: code
      runs_on: [prs]
    keywords: ["semgrep", "github app", "sast", "code analysis"]

  - name: running-in-prs
    description: |
      Proves Semgrep is running on PRs by querying Lunar Hub for Semgrep data
      from recent PRs. Used on the default branch to provide compliance proof
      that PR scanning is happening (since Semgrep GitHub App only posts checks
      on PRs, not directly on the default branch).
    mainBash: running-in-prs.sh
    hook:
      type: code
      runs_on: [default-branch]
    keywords: ["semgrep", "pr scanning", "compliance proof", "default branch"]

  - name: cli
    description: |
      Detects Semgrep CLI executions in CI pipelines. Captures the command
      and version. Categorizes based on flags (--supply-chain for SCA, default SAST).
    mainBash: cli.sh
    hook:
      type: ci-after-command
      pattern: .*\bsemgrep\b.*
    keywords: ["semgrep cli", "ci integration", "sast", "code scanning"]

secrets:
  GH_TOKEN:
    description: GitHub token for API access (required for github-app collector)

example_component_json: |
  {
    "sast": {
      "source": {
        "tool": "semgrep",
        "version": "1.50.0",
        "integration": "github_app"
      },
      "native": {
        "semgrep": {
          "running_in_prs": true,
          "github_app": {
            "id": 12345,
            "name": "Semgrep",
            "status": "completed",
            "conclusion": "success"
          },
          "cicd": {
            "cmds": [
              {"cmd": "semgrep scan --config auto", "version": "1.50.0"}
            ]
          }
        }
      }
    }
  }
