version: 0

name: dockerfile
description: Parses Dockerfiles and collects container definition metadata
author: earthly

default_image: earthly/lunar-lib:dockerfile-main

# Landing page metadata for earthly.dev/lunar/guardrails/collectors/dockerfile
landing_page:
  status: "stable"
  display_name: "Dockerfile"
  tagline: "Parse Dockerfiles and collect container definition metadata including base images and configuration"
  seo_title: "Dockerfile Parser Collector"
  seo_description: |
    Parse Dockerfiles to extract base images, final stage configuration, healthchecks,
    users, and labels. Enforce container security and best practices.
  category: "devex-build-and-ci"
  related:
    - slug: "container"
      type: "policy"
      reason: "Enforces container best practices on collected Dockerfile data"

collectors:
  - name: dockerfile
    description: |
      Parses all Dockerfiles in the repository using dockerfile-json and collects:
      - Container definitions with base images and metadata
      - Final stage information (user, healthcheck)
      - Labels from each stage
    mainBash: main.sh
    hook:
      type: code
    seo_title: "Parse Dockerfile Definitions"
    seo_description: |
      Extract structured data from Dockerfiles including base images, multi-stage builds,
      USER instructions, HEALTHCHECK configuration, and OCI labels.
    seo_keywords: ["dockerfile", "docker", "container images", "base images", "multi-stage builds"]

inputs:
  find_command:
    description: Command to find Dockerfiles (must output one file path per line)
    default: "find . -type f \\( -name Dockerfile -o -name '*.Dockerfile' -o -name 'Dockerfile.*' \\)"

example_component_json: |
  {
    "containers": {
      "source": {
        "tool": "dockerfile-json",
        "version": "1.2.2"
      },
      "definitions": [
        {
          "path": "Dockerfile",
          "valid": true,
          "base_images": [
            {
              "reference": "golang:1.21-alpine",
              "image": "golang",
              "tag": "1.21-alpine"
            },
            {
              "reference": "gcr.io/distroless/static-debian12:nonroot-amd64",
              "image": "gcr.io/distroless/static-debian12",
              "tag": "nonroot-amd64"
            }
          ],
          "final_stage": {
            "base_name": "runtime",
            "base_image": "gcr.io/distroless/static-debian12:nonroot-amd64",
            "user": "nonroot",
            "has_healthcheck": false
          },
          "labels": {
            "org.opencontainers.image.source": "https://github.com/acme/api"
          },
          "native": {
            "ast": { "Stages": ["..."] }
          }
        }
      ]
    }
  }
