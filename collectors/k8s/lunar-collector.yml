version: 0

name: k8s
description: Parses Kubernetes manifests and collects workload, PDB, and HPA metadata. Enforce K8s best practices.
author: earthly

image: +image

landing_page:
  display_name: "Kubernetes Collector"
  long_description: |
    Parse Kubernetes YAML manifests to extract workloads, containers, resource limits,
    probes, PodDisruptionBudgets, and HorizontalPodAutoscalers. Enforce K8s best practices.
  categories: ["orchestration", "containers"]
  icon: "assets/k8s.svg"
  status: "stable"
  related:
    - slug: "dockerfile"
      type: "collector"
      reason: "Collects container definitions that K8s workloads reference"

collectors:
  - name: k8s
    description: |
      Parses all Kubernetes manifests in the repository using kubeconform validation and collects:
      - Manifest validity and parse errors
      - Workloads (Deployments, StatefulSets, DaemonSets, Jobs, CronJobs)
      - Container specs with resource requests/limits and probes
      - PodDisruptionBudgets (PDBs)
      - HorizontalPodAutoscalers (HPAs)
      - Summary flags for policy enforcement
    mainBash: main.sh
    hook:
      type: code
    keywords: ["kubernetes", "k8s", "deployment", "pods", "containers", "resources", "probes", "pdb", "hpa"]

inputs:
  find_command:
    description: Command to find K8s manifest files (must output one file path per line)
    default: "git ls-files '*.yaml' '*.yml'"

example_component_json: |
  {
    "k8s": {
      "source": {
        "tool": "kubeconform",
        "version": "0.6.7"
      },
      "manifests": [
        {
          "path": "deploy/deployment.yaml",
          "valid": true,
          "resources": [
            {"kind": "Deployment", "name": "payment-api", "namespace": "payments"}
          ]
        }
      ],
      "workloads": [
        {
          "kind": "Deployment",
          "name": "payment-api",
          "namespace": "payments",
          "path": "deploy/deployment.yaml",
          "replicas": 3,
          "containers": [
            {
              "name": "api",
              "image": "gcr.io/acme/payment-api:v1.2.3",
              "has_resources": true,
              "has_requests": true,
              "has_limits": true,
              "cpu_request": "100m",
              "cpu_limit": "500m",
              "memory_request": "128Mi",
              "memory_limit": "512Mi",
              "has_liveness_probe": true,
              "has_readiness_probe": true,
              "runs_as_non_root": true,
              "read_only_root_fs": true,
              "privileged": false
            }
          ]
        }
      ],
      "pdbs": [
        {
          "name": "payment-api-pdb",
          "namespace": "payments",
          "path": "deploy/pdb.yaml",
          "target_workload": "payment-api",
          "min_available": 2
        }
      ],
      "hpas": [
        {
          "name": "payment-api-hpa",
          "namespace": "payments",
          "path": "deploy/hpa.yaml",
          "target_workload": "payment-api",
          "min_replicas": 3,
          "max_replicas": 10
        }
      ],
      "summary": {
        "all_valid": true,
        "all_have_resources": true,
        "all_have_probes": true,
        "all_non_root": true,
        "all_have_pdb": true
      }
    }
  }

