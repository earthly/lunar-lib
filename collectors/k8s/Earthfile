VERSION 0.8
# Build the k8s collector image
image:
    FROM --pass-args ../../+base-image

    # Install kubeconform for K8s manifest validation
    ARG TARGETARCH
    ARG KUBECONFORM_VERSION=0.6.7
    RUN ARCH=$(echo "${TARGETARCH}" | sed 's/amd64/amd64/; s/arm64/arm64/') && \
        curl -sSL "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-${ARCH}.tar.gz" | tar xz && \
        mv kubeconform /usr/local/bin/ && \
        chmod +x /usr/local/bin/kubeconform

    # Install GNU parallel for parallel file processing
    RUN apk add --no-cache parallel && \
        mkdir -p ~/.parallel && touch ~/.parallel/will-cite

    ARG VERSION=main
    SAVE IMAGE --push earthly/lunar-lib:k8s-$VERSION

