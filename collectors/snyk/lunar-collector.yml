version: 0

name: snyk
description: Detects Snyk security scans and collects vulnerability data
author: support@earthly.dev

default_image: earthly/lunar-scripts:1.0.0
default_image_ci_collectors: native

landing_page:
  display_name: "Snyk Collector"
  long_description: |
    Detects Snyk security scanning via GitHub App or CLI integration.
    Automatically categorizes results (SCA, SAST, Container, IaC) based on
    scan type and writes to normalized Component JSON paths.
  category: "security-and-compliance"
  icon: "assets/snyk.svg"
  status: "stable"
  related:
    - slug: "dependencies"
      type: "policy"
      reason: "Enforces dependency version requirements using Snyk data"

collectors:
  - name: github-app
    description: |
      Detects Snyk GitHub App scans on pull requests by querying GitHub
      commit status API. Waits for scan completion and captures results.
      Categorizes by scan type (Open Source, Code, Container, IaC).
    mainBash: github-app.sh
    hook:
      type: code
      runs_on: [prs]
    keywords: ["snyk", "github app", "security scanning", "vulnerabilities"]

  - name: github-app-main
    description: |
      Checks if Snyk GitHub App has run on recent PRs by querying the
      Lunar Hub database. Provides proof of scanning on the main branch
      even though Snyk doesn't post checks there directly.
    mainBash: github-app-main.sh
    hook:
      type: code
      runs_on: [default-branch]
    keywords: ["snyk", "main branch", "compliance proof"]

  - name: cli
    description: |
      Detects Snyk CLI executions in CI pipelines. Captures command output
      and categorizes based on subcommand (test, code, container, iac).
    mainBash: cli.sh
    hook:
      type: ci-after-command
      pattern: .*\bsnyk\b.*
    keywords: ["snyk cli", "ci integration", "security scanning"]

secrets:
  - name: GH_TOKEN
    description: GitHub token for API access (checking commit statuses)
    required: true
  - name: PG_PASSWORD
    description: Database password for main branch queries
    required: false

example_component_json: |
  {
    "sca": {
      "source": {
        "tool": "snyk",
        "version": "1.1200.0",
        "integration": "github_app"
      },
      "vulnerabilities": {
        "critical": 0,
        "high": 1,
        "medium": 3,
        "low": 8,
        "total": 12
      },
      "native": {
        "snyk": {
          "github_app_results": {
            "state": "success",
            "context": "security/snyk",
            "target_url": "https://app.snyk.io/..."
          }
        }
      }
    }
  }
