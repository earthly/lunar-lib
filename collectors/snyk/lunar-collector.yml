version: 0

name: snyk
description: Detects Snyk security scans via GitHub App or CLI integration
author: support@earthly.dev

default_image: earthly/lunar-lib:base-main
default_image_ci_collectors: native

landing_page:
  display_name: "Snyk Collector"
  long_description: |
    Detects Snyk security scanning via GitHub App or CLI integration.
    Automatically categorizes results (SCA, SAST, Container, IaC) based on
    scan type and writes to normalized Component JSON paths.
  category: "security"
  icon: "assets/snyk.svg"
  status: "stable"
  related:
    - slug: "dependencies"
      type: "policy"
      reason: "Enforces dependency version requirements using Snyk data"

collectors:
  - name: github-app
    description: |
      Detects Snyk GitHub App scans on pull requests by querying GitHub
      commit status API. Waits for scan completion and captures results.
      Categorizes by scan type (Open Source, Code, Container, IaC).
    mainBash: github-app.sh
    hook:
      type: code
      runs_on: [prs]
    keywords: ["snyk", "github app", "security scanning", "vulnerabilities"]

  - name: running-in-prs
    description: |
      Proves Snyk is running on PRs by querying Lunar Hub for Snyk data
      from recent PRs. Used on the default branch to provide compliance proof
      that PR scanning is happening (since Snyk GitHub App only posts checks
      on PRs, not directly on the default branch).
    mainBash: running-in-prs.sh
    hook:
      type: code
      runs_on: [default-branch]
    keywords: ["snyk", "pr scanning", "compliance proof", "default branch"]

  - name: cli
    description: |
      Detects Snyk CLI executions in CI pipelines. Captures the command
      and exit code, then categorizes by subcommand (test, code, container, iac).
    mainBash: cli.sh
    hook:
      type: ci-after-command
      pattern: .*\bsnyk\b.*
    keywords: ["snyk cli", "ci integration", "security scanning"]

secrets:
  - name: GH_TOKEN
    description: GitHub token for API access (required for github-app collector)
    required: false
  - name: PG_CONNECTION_STRING
    description: Direct PostgreSQL connection string (optional, overrides other PG_* secrets)
    required: false
  - name: PG_PASSWORD
    description: Database password for running-in-prs collector (optional, uses lunar sql connection-string if not set)
    required: false
  - name: PG_USER
    description: Database user for running-in-prs collector (optional, defaults to api3)
    required: false

example_component_json: |
  {
    "sca": {
      "source": {
        "tool": "snyk",
        "version": "1.1200.0",
        "integration": "github_app"
      },
      "native": {
        "snyk": {
          "github_app_results": {
            "state": "success",
            "context": "security/snyk",
            "target_url": "https://app.snyk.io/..."
          }
        }
      }
    },
    "iac_scan": {
      "source": {
        "tool": "snyk",
        "integration": "github_app"
      },
      "native": {
        "snyk": {
          "github_app_results": {
            "state": "success",
            "context": "security/snyk-iac",
            "target_url": "https://app.snyk.io/..."
          }
        }
      }
    }
  }
