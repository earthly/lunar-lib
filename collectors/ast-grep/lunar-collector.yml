version: 0

name: ast-grep
description: Extracts code patterns using AST-based analysis with ast-grep
author: earthly

default_image: earthly/lunar-lib:ast-grep-main

landing_page:
  display_name: "AST-Grep Collector"
  long_description: |
    Analyze source code using AST-based pattern matching with ast-grep. Define custom
    rules to detect security issues, anti-patterns, and code style violations.
  categories: ["code-analysis", "security"]
  icon: "assets/ast-grep.svg"
  status: "beta"
  related: []

collectors:
  - name: ast-grep
    description: |
      Runs user-defined ast-grep YAML rules against source code and collects pattern matches.
      Supports full ast-grep rule syntax including relational rules (inside, has), composite
      rules (all, any, not), and metavariables ($VAR, $$$ARGS). Groups results by rule ID
      (format: category.subcategory) and writes structured matches with file, range, and code
      snippet to .code_patterns.<category>.<subcategory>.
    mainBash: main.sh
    hook:
      type: code
    keywords: ["ast-grep", "code patterns", "static analysis", "security scanning"]

inputs:
  rules:
    description: |
      Multi-line YAML string containing ast-grep rules. Use YAML multi-document
      syntax (---) to define multiple rules. Rule IDs should follow the format
      <category>.<subcategory> to map to Component JSON paths.
      Example: id: security.sql_concat -> .code_patterns.security.sql_concat
  exclude_paths:
    description: Comma-separated paths to exclude from scanning
    default: "vendor,node_modules,.git,dist,build"
  max_matches_per_rule:
    description: Maximum matches to report per rule (prevents huge output)
    default: "100"
  debug:
    description: Enable debug output (echoes rules and raw ast-grep output)
    default: "false"

example_component_json: |
  {
    "code_patterns": {
      "source": {
        "tool": "ast-grep",
        "version": "0.40.5"
      },
      "security": {
        "sql_concat": {
          "count": 0,
          "message": "SQL query built via string concatenation",
          "severity": "error",
          "matches": []
        },
        "eval": {
          "count": 2,
          "message": "Dangerous eval() usage",
          "severity": "error",
          "matches": [
            {
              "file": "utils/dynamic.py",
              "range": { "start": { "line": 45, "column": 8 }, "end": { "line": 45, "column": 25 } },
              "code": "eval(user_input)"
            },
            {
              "file": "handlers/admin.py",
              "range": { "start": { "line": 112, "column": 12 }, "end": { "line": 112, "column": 30 } },
              "code": "exec(code_string)"
            }
          ]
        }
      },
      "logging": {
        "printf": {
          "count": 5,
          "message": "Use structured logging instead of fmt.Printf",
          "severity": "warning",
          "matches": [
            {
              "file": "handler.go",
              "range": { "start": { "line": 42, "column": 2 }, "end": { "line": 42, "column": 38 } },
              "code": "fmt.Printf(\"User: %s\", user)"
            }
          ]
        }
      }
    }
  }
