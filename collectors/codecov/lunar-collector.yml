version: 0

name: codecov
description: |
  Detects Codecov usage and fetches coverage results from the Codecov API.
author: earthly

default_image: native

# Landing page metadata for earthly.dev/lunar/guardrails/collectors/codecov
landing_page:
  status: "stable"
  display_name: "Codecov"
  tagline: "Detect Codecov usage and fetch coverage results from the Codecov API"
  seo_title: "Codecov Coverage Collector"
  seo_description: |
    Automatically detect Codecov runs in CI and fetch coverage percentage and file-level
    details. Track test coverage trends across your organization.
  category: "testing-and-quality"
  related:
    - slug: "coverage"
      type: "policy"
      reason: "Vendor-agnostic coverage policies that work with Codecov data"

collectors:
  - name: ran
    description: Records that codecov ran (writes source metadata)
    mainBash: ran.sh
    hook:
      type: ci-after-command
      pattern: codecov(cli)?|bash.*codecov
    seo_title: "Detect Codecov Execution"
    seo_description: |
      Records when Codecov runs in your CI pipeline, establishing presence
      of coverage tooling for downstream policies.
    seo_keywords: ["codecov", "coverage detection", "ci integration"]

  - name: results
    description: Fetches coverage results from Codecov API
    mainBash: results.sh
    hook:
      type: ci-after-command
      pattern: codecov(cli)?|bash.*codecov
    seo_title: "Fetch Coverage Results"
    seo_description: |
      Retrieves coverage percentage and file-level details from the Codecov API
      after upload completes.
    seo_keywords: ["code coverage", "coverage percentage", "codecov api", "test coverage"]

inputs:
  use_env_token:
    description: Use CODECOV_TOKEN from environment instead of Lunar secret
    default: "false"

secrets:
  CODECOV_API_TOKEN:
    description: Codecov API token for fetching coverage results (required for results collector)

example_component_json: |
  {
    "testing": {
      "coverage": {
        "source": {
          "tool": "codecov",
          "integration": "ci",
          "version": "0.7.2"
        },
        "percentage": 85.5,
        "native": {
          "codecov": {
            "totals": {
              "files": 3,
              "lines": 1250,
              "hits": 1068,
              "misses": 182,
              "partials": 0,
              "coverage": 85.5
            },
            "files": [
              {
                "name": "src/main.py",
                "totals": {
                  "lines": 500,
                  "hits": 450,
                  "misses": 50,
                  "coverage": 90.0
                }
              }
            ]
          }
        }
      }
    }
  }
