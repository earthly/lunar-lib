version: 0

name: docker
description: Collect Docker container metadata from Dockerfiles and CI build commands
author: earthly

default_image: earthly/lunar-lib:docker-main
default_image_ci_collectors: native

landing_page:
  display_name: "Docker Collector"
  long_description: |
    Parse Dockerfiles to extract base images, labels, and security configuration.
    Capture Docker build commands in CI for traceability and compliance enforcement.
  categories: ["containers", "ci-cd"]
  icon: "assets/docker.svg"
  status: "stable"
  related:
    - slug: "container"
      type: "policy"
      reason: "Enforces container best practices on collected Docker data"

collectors:
  - name: dockerfile
    description: |
      Parses all Dockerfiles in the repository using dockerfile-json and collects:
      - Container definitions with base images and metadata
      - Final stage information (user, healthcheck)
      - Labels from each stage
    mainBash: main.sh
    hook:
      type: code
    keywords: ["dockerfile", "docker", "container images", "base images", "multi-stage builds"]

  - name: cicd
    description: |
      Tracks all docker commands executed in CI pipelines. Records every invocation
      for audit trails. For build commands, also parses image tags, labels, platform,
      and Dockerfile paths into normalized build metadata.
    mainBash: cicd.sh
    hook:
      type: ci-after-command
      binary:
        name: docker
    keywords: ["docker build", "docker push", "container build", "image tags", "build labels", "ci builds"]

inputs:
  find_command:
    description: Command to find Dockerfiles (must output one file path per line)
    default: "find . -type f \\( -name Dockerfile -o -name '*.Dockerfile' -o -name 'Dockerfile.*' \\)"

example_component_json: |
  {
    "containers": {
      "source": {
        "tool": "dockerfile-json",
        "version": "1.2.2"
      },
      "definitions": [
        {
          "path": "Dockerfile",
          "valid": true,
          "base_images": [
            {
              "reference": "golang:1.21-alpine",
              "image": "golang",
              "tag": "1.21-alpine"
            }
          ],
          "final_stage": {
            "base_name": "runtime",
            "base_image": "gcr.io/distroless/static-debian12:nonroot-amd64",
            "user": "nonroot",
            "has_healthcheck": false
          },
          "labels": {
            "org.opencontainers.image.source": "https://github.com/acme/api"
          }
        }
      ],
      "builds": [
        {
          "cmd": "docker build -t myregistry.io/app:v1.2.3 --label git_sha=abc123 -f Dockerfile.prod .",
          "has_tag": true,
          "image": "myregistry.io/app",
          "tag": "v1.2.3",
          "labels": {"git_sha": "abc123"},
          "expected_git_sha": "abc123def456...",
          "platform": null,
          "dockerfile": "Dockerfile.prod"
        }
      ],
      "native": {
        "docker": {
          "cicd": {
            "cmds": [
              {"cmd": "docker build -t myregistry.io/app:v1.2.3 --label git_sha=abc123 -f Dockerfile.prod .", "version": "24.0.7"},
              {"cmd": "docker push myregistry.io/app:v1.2.3", "version": "24.0.7"}
            ],
            "source": {"tool": "docker", "integration": "ci"}
          }
        }
      }
    }
  }
