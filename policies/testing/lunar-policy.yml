version: 0

name: testing
description: Validates that tests are executed, pass, and meet coverage thresholds
author: support@earthly.dev

default_image: earthly/lunar-scripts:1.0.0

landing_page:
  display_name: "Testing Guardrails"
  long_description: |
    Ensure tests are executed in CI, passing, and meet coverage thresholds.
  category: "testing-and-quality"
  icon: "assets/testing.svg"
  status: "stable"
  requires:
    - slug: "golang"
      type: "collector"
      reason: "Provides test execution and coverage data for Go projects"
    - slug: "codecov"
      type: "collector"
      reason: "Provides coverage data from Codecov"
  related: []

policies:
  - name: executed
    description: Ensures tests were executed in CI. Skips if project does not contain a specified language.
    mainPython: ./executed.py
    keywords: ["tests", "ci", "test execution", "quality"]

  - name: passing
    description: Ensures all tests pass. Skips if project does not contain a specified language.
    mainPython: ./passing.py
    keywords: ["tests", "passing", "test results", "quality"]

  - name: coverage-collected
    description: Ensures coverage data is being collected in CI. Skips if project does not contain a specified language.
    mainPython: ./coverage_collected.py
    keywords: ["coverage", "code coverage", "ci", "quality"]

  - name: min-coverage
    description: Enforces a minimum code coverage threshold. Skips if project does not contain a specified language.
    mainPython: ./min_coverage.py
    keywords: ["coverage", "coverage threshold", "minimum coverage", "quality"]

inputs:
  required_languages:
    description: Comma-separated list of languages to enforce testing for. Skips components without a matching language project.
    default: ""
  min_coverage:
    description: Minimum required coverage percentage (default 80%).
    default: "80"
