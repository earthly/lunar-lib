version: 0

name: testing
description: Validates that tests are executed, pass, and meet coverage thresholds
author: support@earthly.dev

default_image: earthly/lunar-scripts:1.0.0

landing_page:
  display_name: "Testing Guardrails"
  long_description: |
    Ensure tests are executed in CI, passing, and meet coverage thresholds.
    Works with any collector that writes to the normalized .testing paths.
  category: "testing-and-quality"
  icon: "assets/testing.svg"
  status: "stable"
  requires:
    - slug: "golang"
      type: "collector"
      reason: "Provides test execution and coverage data for Go projects"
    - slug: "codecov"
      type: "collector"
      reason: "Provides coverage data from Codecov"
  related: []

policies:
  - name: executed
    description: |
      Ensures tests were executed in CI.
      Fails if no test execution data is found.
    mainPython: ./executed.py
    keywords: ["tests", "ci", "test execution", "quality"]

  - name: passing
    description: |
      Ensures all tests pass. Skips if pass/fail data is not available
      (some collectors only report execution, not results).
    mainPython: ./passing.py
    keywords: ["tests", "passing", "test results", "quality"]

  - name: coverage-collected
    description: |
      Ensures coverage data is being collected in CI.
      Fails if no coverage data is found.
    mainPython: ./coverage_collected.py
    keywords: ["coverage", "code coverage", "ci", "quality"]

  - name: min-coverage
    description: |
      Enforces a minimum code coverage threshold (default 80%).
      Skips if coverage data is not available.
    mainPython: ./min_coverage.py
    keywords: ["coverage", "coverage threshold", "minimum coverage", "quality"]

inputs:
  required_languages:
    description: |
      Comma-separated list of languages that require tests.
      Components without a detected project for any of these languages will be skipped.
      Checks for .lang.<language> existence (set by language collectors like golang, python, etc.)
      Example: "go,python,nodejs,java"
      If empty, the policy applies to all components.
    default: ""
  min_coverage:
    description: Minimum required coverage percentage (for min-coverage check)
    default: "80"
