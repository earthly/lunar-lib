version: 0

name: iac
description: Infrastructure as Code configuration and best practices
author: support@earthly.dev

default_image: earthly/lunar-lib:base-main

landing_page:
  display_name: "IaC Guardrails"
  long_description: |
    Enforce Infrastructure as Code best practices including configuration validity,
    WAF protection, datastore durability, and infrastructure availability.
    Works with any IaC collector that writes to the .iac schema.
  category: "deployment-and-infrastructure"
  icon: "assets/iac.svg"
  status: "beta"
  requires:
    - slug: "terraform"
      type: "collector"
      reason: "Provides parsed IaC configuration data"

  related:
    - slug: "terraform"
      type: "policy"
      reason: "Terraform-specific guardrails (providers, modules, backend)"

policies:
  - name: valid
    description: |
      Validates that all IaC configuration files are syntactically correct.
      Invalid configurations will fail deployment.
    mainPython: valid.py
    keywords: ["iac", "terraform", "syntax", "validation", "hcl"]

  - name: waf-protection
    description: |
      Requires WAF protection for internet-facing services. Analyzes IaC resources
      to detect public load balancers, API gateways, and CloudFront distributions,
      then verifies WAF association.
    mainPython: waf_protection.py
    keywords: ["iac", "waf", "security", "internet facing", "load balancer"]

  - name: datastore-durability
    description: |
      Ensures datastores (databases, storage, caches) have deletion protection
      enabled via lifecycle { prevent_destroy = true }. Prevents accidental data
      loss from destroy operations or resource replacement.
    mainPython: datastore_durability.py
    keywords: ["iac", "datastores", "deletion protection", "durability", "prevent_destroy"]

  - name: infra-availability
    description: |
      Ensures infrastructure resources like EC2 instances, load balancers, and
      networking components have availability best practices such as multi-AZ
      deployment and auto-scaling configured.
    mainPython: infra_availability.py
    keywords: ["iac", "availability", "multi-az", "auto-scaling", "high availability"]

inputs:
  extra_datastore_types:
    description: |
      Comma-separated list of additional Terraform resource types to treat as datastores,
      beyond the built-in defaults (aws_s3_bucket, aws_db_instance, aws_dynamodb_table,
      aws_elasticache_cluster, aws_elasticache_replication_group, aws_ebs_volume,
      aws_efs_file_system).
    default: ""
