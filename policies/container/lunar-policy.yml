version: 0

name: container
description: Container definition and build policies
author: earthly

default_image: earthly/lunar-lib:base-main

landing_page:
  display_name: "Container Guardrails"
  long_description: |
    Enforce container best practices including tag stability, registry allowlists,
    required labels, build traceability, and security configurations.
  category: "devex-build-and-ci"
  icon: "assets/container.svg"
  status: "stable"
  requires:
    - slug: "docker"
      type: "collector"
      reason: "Provides Dockerfile and build data that these policies evaluate"
  related: []

policies:
  - name: no-latest
    description: |
      Prevents use of the :latest tag (explicit or implicit) in base images.
      Using :latest creates non-reproducible builds and makes debugging difficult.
    mainPython: no_latest.py
    keywords: ["dockerfile", "latest tag", "reproducible builds", "image tags"]

  - name: stable-tags
    description: |
      Requires base images to use stable tags: digests (sha256:...) or full semver (1.2.3).
      Partial versions like "node:20" can change unexpectedly and break builds.
    mainPython: stable_tags.py
    keywords: ["semver", "image digest", "version pinning", "tag policy"]

  - name: allowed-registries
    description: |
      Restricts base images to approved container registries only.
      Prevents supply chain attacks from untrusted image sources.
    mainPython: allowed_registries.py
    keywords: ["container registry", "supply chain security", "registry policy"]

  - name: required-labels
    description: |
      Ensures Dockerfiles include required OCI labels for traceability.
      Common labels: org.opencontainers.image.source, version, maintainer.
    mainPython: required_labels.py
    keywords: ["dockerfile labels", "oci labels", "image metadata"]

  - name: healthcheck
    description: |
      Requires a HEALTHCHECK instruction in the final stage of multi-stage builds.
      Enables container orchestrators to detect and restart unhealthy containers.
    mainPython: healthcheck.py
    keywords: ["healthcheck", "kubernetes", "container orchestration", "docker health"]

  - name: user
    description: |
      Requires a USER instruction to run the container as a non-root user.
      Running as root inside containers is a security risk and violates least privilege.
    mainPython: user.py
    keywords: ["non-root", "container security", "least privilege", "USER instruction"]

  - name: build-tagged
    description: |
      Requires container builds to use an explicit image tag via -t/--tag.
      Untagged builds produce anonymous images that cannot be tracked or deployed.
    mainPython: build_tagged.py
    keywords: ["docker build", "image tags", "container registry", "build tagging"]

  - name: build-required-labels
    description: |
      Ensures container build commands include required labels for traceability.
      Checks --label flags on docker build commands against a configurable list.
    mainPython: build_labels.py
    keywords: ["build labels", "git sha", "image provenance", "build traceability"]

inputs:
  allowed_registries:
    description: Comma-separated list of allowed registries
    default: "docker.io"
  required_labels:
    description: Comma-separated list of required Dockerfile labels (empty = no requirement)
    default: ""
  required_build_labels:
    description: Comma-separated list of required build command labels (empty = no requirement)
    default: ""
